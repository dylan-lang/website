<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
  <head>
    
    <!-- Relative Navigation -->
    
    <link rel="up" href="Macros" />
    <link rel="prev" href="Auxiliary_Rule_Sets" />
    <link rel="next" href="Rewrite_Rule_Examples" />
    
    <!-- Absolute Navigation -->
    
    <link rel="top" href="Title" />
    <link rel="start first" href="." />
    <link rel="copyright" href="Copyrights" />
    <link rel="contents" href="Contents" />
    <link rel="glossary" href="Glossary" />
    <link rel="index" href="Index" />
    <link rel="last author" href="Colophon" />
    
    <!-- Chapters -->
    
    <link rel="chapter" title="About This Book" href="Preface" />
    <link rel="chapter" title="1 Introduction" href="Introduction" />
    <link rel="chapter" title="2 Syntax" href="Syntax" />
    <link rel="chapter" title="3 Program Structure" href="Program_Structure" />
    <link rel="chapter" title="4 Program Control" href="Program_Control" />
    <link rel="chapter" title="5 Types and Classes" href="Types_and_Classes" />
    <link rel="chapter" title="6 Functions" href="Functions" />
    <link rel="chapter" title="7 Conditions" href="Conditions" />
    <link rel="chapter" title="8 Collections" href="Collections" />
    <link rel="chapter" title="9 Sealing" href="Sealing" />
    <link rel="chapter" title="10 Macros" href="Macros" />
    <link rel="chapter" title="11 The Built-In Classes" href="Built-In_Classes" />
    <link rel="chapter" title="12 The Built-In Functions" href="Built-In_Functions" />
    <link rel="chapter" title="13 Other Built-In Objects" href="Other_Built-In_Objects" />
    <link rel="chapter" title="14 The Built-In Macros and Special Definitions" href="Built-In_Macros_and_Special_Definitions" />
    
    <!-- Appendices -->
    
    <link rel="appendix" title="A BNF" href="BNF" />
    <link rel="appendix" title="B Exported Names" href="Exported_Names" />
    
    <!-- Stylesheets -->
    
    <link rel="stylesheet" href="styles/common.css" type="text/css" />
    <link rel="stylesheet" href="styles/nav-top-fixed.css" type="text/css" media="handheld" />
    <link rel="stylesheet" href="styles/nav-left-fixed.css" type="text/css" media="screen" title="Navigation at Left" />
    <link rel="stylesheet alternate" href="styles/nav-top-fixed.css" type="text/css" media="screen" title="Navigation at Top" />

    <title>Hygiene &mdash; 10. Macros &mdash; The DRM</title>
  </head>
  <body class="content">

    <div id="header">
      <div id="navigation-header">
	<div id="navigation-top">
	  <div class="background">
	    <p id="book-title">
	    <img class="book-icon" alt="" src="images/color-square-small.png" width="22" height="21" />
	    <a href="Title"><img class="book-title" alt="The Dylan Reference Manual" src="images/book-title.png" width="343" height="28" /></a>
	  </p>
	  <p id="navigation-core">
	    <a class="previous" accesskey="p" title="Previous Page" href="Auxiliary_Rule_Sets"><span>&larr; Previous</span></a>
	    <a class="next" accesskey="n" title="Next Page" href="Rewrite_Rule_Examples"><span>Next Page &rarr;</span></a>
	    <a class="up" accesskey="u" title="Chapter Start" href="Macros"><span>Up</span></a>
	    <a class="start" accesskey="s" title="Start of Book" href="Title"><span>Start</span></a>
	    <a class="contents" accesskey="c" title="Contents" href="Contents"><span>Contents</span></a>
	    <a class="index" accesskey="i" title="Index" href="Index"><span>Index</span></a>
	  </p>
	</div>
	</div>
	<div id="navigation-TOC">
	  <ul class="front-matter">
	    <li id="book-start"><a href="Title">Start</a></li>
	    <li><a href="Contents">Contents</a></li>
	    <li><a href="Preface">About This Book</a></li>
	  </ul>
	  <ol class="chapters">
	    <li><a href="Introduction">Introduction</a></li>
	    <li><a href="Syntax">Syntax</a></li>
	    <li><a href="Program_Structure">Program Structure</a></li>
	    <li><a href="Program_Control">Program Control</a></li>
	    <li><a href="Types_and_Classes">Types and Classes</a></li>
	    <li><a href="Functions">Functions</a></li>
	    <li><a href="Conditions">Conditions</a></li>
	    <li><a href="Collections">Collections</a></li>
	    <li><a href="Sealing">Sealing</a></li>
	    <li class="current parent"><a href="Macros">Macros</a>
	      <ul class="sections">
		<li><a href="Macros_Overview">Overview</a></li>
		<li><a href="Extensible_Grammar">Extensible Grammar</a></li>
		<li><a href="Macro_Names">Macro Names</a></li>
		<li><a href="Rewrite_Rules">Rewrite Rules</a></li>
		<li><a href="Patterns">Patterns</a></li>
		<li><a href="Pattern_Variable_Constraints">Pattern Variable Constraints</a></li>
		<li><a href="Templates">Templates</a></li>
		<li><a href="Auxiliary_Rule_Sets">Auxiliary Rule Sets</a></li>
		<li id="current" class="subsections"><a href="Hygiene">Hygiene</a>
		  <ul class="page-TOC">
		    <li><a href="#HEADING-85-12">Intentional Hygiene Violation</a></li>
		    <li><a href="#HEADING-85-15">Hygiene Versus Module Encapsulation</a></li>
		  </ul>
		</li>
		<li><a href="Rewrite_Rule_Examples">Rewrite Rule Examples</a></li>
	      </ul>
	    </li>
	    <li><a href="Built-In_Classes">The Built-In Classes</a></li>
	    <li><a href="Built-In_Functions">The Built-In Functions</a></li>
	    <li><a href="Other_Built-In_Objects">Other Built-In Objects</a></li>
	    <li><a href="Built-In_Macros_and_Special_Definitions">The Built-In Macros and Special Definitions</a></li>
	  </ol>
	  <ol class="appendices">
	    <li><a href="BNF">BNF</a></li>
	    <li><a href="Exported_Names">Exported Names</a></li>
	  </ol>
	  <ul class="back-matter">
	    <li><a href="Glossary">Glossary</a></li>
	    <li><a href="Index">Index</a></li>
	    <li><a href="Colophon">Colophon</a></li>
	  </ul>
	  <ul class="errata">
	    <li><a href="Errata">Errata</a></li>
	  </ul>
	</div>
      </div>

      <hr />

    </div>

    <div id="content">
      <div id="section-header">
	<p id="section-prefix">Chapter 10</p>
	<p id="section-name">Macros</p>
      </div>

      <a name="HEADING-85-0"></a>
      <a name="UID-Macros-1884"></a>
      <h1 class="section-title"><a name="XREF-1268"></a><a name="IX-1269">Hygiene</a></h1>
      <p>Dylan macros are always <dfn>hygienic</dfn>. The basic idea is that
	each <a name="IX-1270">named value reference</a> in a macro expansion means the same thing
	as it meant at the place in the original source code from which it was copied into the macro
	expansion. This is true whether that place was in the macro definition or in the macro
	call. Because a macro expansion can include macro calls that need further expansion, named
	value references in one final expansion can come from several different macro definitions
	and can come from several different macro calls, either to different macros or&mdash;in the
	case of recursion&mdash;distinct calls to the same macro.</p>
      <p>(Sometimes the property that variable references copied from a macro call mean the same
	thing in the expansion is called <q>hygiene</q> and the property that variable references
	copied from a macro definition mean the same thing in the expansion is
	called <q><a name="IX-1271">referential transparency.</a></q> We include both
	properties in the term <q>hygiene.</q>)</p>
      <p>Specifically, a macro can bind <a name="IX-1272">temporary variables in</a> its expansion
	without the risk of accidentally capturing references in the macro call to another binding
	with the same name. Furthermore, a macro can reference module bindings in its expansion
	without the risk of those references accidentally being <a name="IX-1273">captured by
	bindings</a> of other variables with the same name that surround the macro call. A macro can
	reference module bindings in its expansion without worrying that the intended bindings might
	have different names in a module where the macro is called.</p>
      <p>One way to implement this is for each <var>template-element</var> that is
	a <em class="BNFCaps">name</em>, <em class="BNFCaps">unary-operator</em>,
	or <em class="BNFCaps">binary-operator</em> to be replaced in the macro expansion by a
	special token that plays the same grammatical role as
	the <em class="BNFCaps">name</em>, <em class="BNFCaps">unary-operator</em>,
	or <em class="BNFCaps">binary-operator</em> but remembers three pieces of information:</p>
      <ul>
	<li>The original <em class="BNFCaps">name</em>. For an operator, this is the name listed
	  in <a href="Operators#XREF-427">Table 4-1 on page 37</a>.</li>
	<li>The lexical context where the macro was defined, which is just a module since macro
	  definitions are only allowed at top level, not inside of bindings.</li>
	<li>The specific macro call occurrence. This could be an integer that is incremented each
	  time a macro expansion occurs.</li>
      </ul>
      <p>In general one cannot know until all macros are expanded whether
	a <em class="BNFCaps">name</em> is a bound variable reference, a module binding reference, a
	variable that is being bound, or something that is not a binding name at all, such as a
	definition <var>modifier</var> or an intermediate word. Similarly, one cannot know until all
	macros are expanded whether a <em class="BNFCaps">unary-operator</em>
	or <em class="BNFCaps">binary-operator</em> refers to a local binding or a module
	binding. Thus the information for each of those cases is retained in the special token. A
	named value reference and a binding connect if and only if the
	original <em class="BNFCaps">names</em> and the specific macro call occurrences are both the
	same. (In that case, the lexical contexts will also be the same, but this need not be
	checked.) A named value reference and a binding never connect if one originated in a
	template and the other originated in a macro call.</p>
      <p>References in a macro expansion to <code>element</code> or <code>aref</code> created by
	using <a name="IX-1274">element reference syntax</a> must receive similar treatment so
	the <em class="BNFCaps">name</em> <code>element</code> or <code>aref</code> gets looked up
	in the environment of the macro definition, not the environment of the macro call.</p>
      <p>For purposes of hygiene, a <var>pattern-keyword default</var> is treated like part of a
	template, even though it is actually part of a pattern.</p>
      <p><a name="IX-1275">The mapping from getters to setters done by the <code>:=</code> operator
	is hygienic.</a> In all cases the setter name is looked up in the same lexical context and
	macro call occurrence as the getter name.</p>
      <a name="HEADING-85-12"></a>
      <a name="UID-Macros-1902"></a>
      <h2 class="subsection-title"><a name="IX-1276">Intentional Hygiene Violation</a></h2>
      <p>Sometimes it is necessary for a macro to violate the hygienic property, for example to
	include in a macro expansion a named value reference to be executed in the lexical context
	where the macro was called, not the lexical context where the macro was defined. Another
	example is creating a local binding in a macro expansion that will be visible to the body of
	the macro. This feature should be used sparingly, as it can be confusing to users of the
	macro, but sometimes it is indispensable.</p>
      <p>The construct <code>?=<i class="cv"> <em class="BNFCaps cv">name</em></i></code> in a
	template inserts into the expansion a reference to <em class="BNFCaps">name</em>, in the
	lexical context where the macro was called. It is as if <em class="BNFCaps">name</em> came
	from the macro call rather than from the template.<a name="IX-1277"></a></p>
      <a name="HEADING-85-15"></a>
      <a name="UID-Macros-1906"></a>
      <h2 class="subsection-title"><a name="IX-1278">Hygiene Versus Module Encapsulation</a></h2>
      <p>A named value reference in a macro expansion that was produced by
	a <var>template-element</var> that is a <em class="BNFCaps">name</em>,
	<em class="BNFCaps">unary-operator</em>, <em class="BNFCaps">binary-operator</em>,
	or <code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> and that does
	not refer to a local binding created by the macro expansion must have the same meaning as
	would a named value reference with the same name adjacent to the macro definition. This is
	true even if the macro call is in a different module or a different library from the one in
	which the macro definition occurs, even if the binding is not exported.</p>
      <p>This allows exported macros to make use of private bindings without requiring these
	bindings to be exported for general use. The module that calls the macro does not need to
	import the private bindings used by the expansion.</p>
      <p>If one of the following template-element sequences appears in the right-hand side of a
	rewrite rule, it may introduce named value references to the indicated name in an expansion
	of the macro. If such a named value reference does not refer to a local binding created by
	the macro expansion then it must have the same meaning as would a named value reference with
	the same name adjacent to the macro definition.</p>
      <ul>
	<li><var>variable-name</var><br /><br />Reference to <var>variable-name</var></li>
	<li><var>getter-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>)</code> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <var>getter-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>)</code> <code>)</code><br /><br />Reference to <var>getter-name</var> <code>##</code> <code>"-setter"</code></li>
	<li><code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> <code>)</code><br /><br />Reference to either <code>element-setter</code> and <code>aref-setter</code></li>
	<li><code>.</code> <var>getter-name</var> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>.</code> <var>getter-name</var> <code>)</code><br /><br />Reference to <var>getter-name</var> <code>##</code> <code>"-setter"</code></li>
	<li><code>define</code> <var>definition-head<em><sub>opt</sub></em></var> <var>definer-name</var><br /><br />Reference to <var>definer-name</var> <code>##</code> <code>"-definer"</code></li>
      </ul>
      <p>Items in the preceding template-element sequences have the following meanings:</p>
      <ul class="no-bullet">
	<li>
	  <ul>
	    <li><var>assignment-operator-name</var> is a <em class="BNFCaps">name</em>, and the
	      value of the binding with that name (in the module containing the macro definition in
	      which the template occurs) is the assignment macro that is the value of the binding
	      named <code>\:= </code>exported by the Dylan module of the Dylan library.</li>
	    <li><var>assignment-operator</var> is a binary-operator whose associated binding is
	      an <var>assignment-operator-name</var>.</li>
	    <li><var>definer-name</var> is a <em class="BNFCaps">define-body-word</em>
	      or <em class="BNFCaps">define-list-word</em>.</li>
	    <li><var>variable-name</var> and <var>getter-name</var>
	      are <em class="BNFCaps">name</em>s.</li>
	    <li><var>template</var> is defined in <a href="BNF">Appendix A, <q>BNF,</q></a>
	      on <a href="Phrase_Grammar#XREF-2121">page 429</a>.</li>
	    <li><var>definition-head</var> is defined in <a href="BNF">Appendix A, <q>BNF,</q></a>
	      on <a href="Phrase_Grammar#XREF-2117">page 427</a>.</li>
	    <li>The notation <var>foo</var> <code>##</code> <code>"string"</code> indicates a new
	      token composed of the text of <var>foo</var> concatenated with the string.</li>
	  </ul>
	</li>
      </ul>
      <p>Note that these template-element sequences can overlap in a template. For example <code>{
	  foo (bar) := }</code> is a potential reference to <code>foo</code>,
	to <code>foo-setter</code>, and to <code>bar</code>.</p>
      <p>Implementations must use some automatic mechanism for noting the bindings associated with
	the named value references in macro expansions produced by the template-element sequences
	described above, and must make such bindings available to any library where the macro is
	accessible. In general, the set of bindings that must be made available to other libraries
	cannot be computed precisely because the right-hand sides of rewrite rules are not fully
	parsed until after a macro is called and expanded, making it impossible to determine whether
	an occurrence of one of the described sequences of template elements will actually produce a
	named variable reference in the expansion. However, an upper bound on this set of bindings
	can be computed by assuming that all occurrences of the described template-element sequences
	might introduce the indicated named value reference if there is a binding for that name
	accessible from the module in which the macro definition
	appears.<a name="IX-1279"></a><a name="IX-1280"></a></p>

    </div>

    <div id="footer">

      <hr />
      <address>The Dylan Reference Manual - 7 Apr 1998</address>
      <p id="navigation-footer">
	<a class="previous" accesskey="p" title="Previous Page" href="Auxiliary_Rule_Sets"><span>&larr; Previous</span></a>
	<a class="next" accesskey="n" title="Next Page" href="Rewrite_Rule_Examples"><span>Next Page &rarr;</span></a>
	<a class="up" accesskey="u" title="Chapter Start" href="Macros"><span>Up</span></a>
	<a class="start" accesskey="s" title="Start of Book" href="Title"><span>Start</span></a>
	<a class="contents" accesskey="c" title="Contents" href="Contents"><span>Contents</span></a>
	<a class="index" accesskey="i" title="Index" href="Index"><span>Index</span></a>
      </p>
      <p>Copyright Apple Computer, Inc. 1996. Apple&reg; and the Apple logo are registered
	trademarks of Apple Computer, Inc. Used with permission. All Rights Reserved.</p>
      <p>Originally generated with Harlequin WebMaker&reg;, subsequently revised.</p>
    </div>
  </body>
</html>
